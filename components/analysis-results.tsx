"use client"

import { useState } from "react"
import { CheckCircle, AlertTriangle, XCircle, Download, FileText, AlertCircle } from "lucide-react"
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Progress } from "@/components/ui/progress"
import { cn } from "@/lib/utils"
import type { AnalysisResult } from "@/app/page"
import Image from "next/image"

const TUMOR_INFO: Record<string, {
  name: string
  description: string
  symptoms: string
  treatment: string
  prognosis: string
}> = {
  glioma: {
    name: "Glioma",
    description: "A tumor that originates from glial cells in the brain or spine.",
    symptoms: "Headaches, seizures, memory loss, personality changes, nausea",
    treatment: "Surgery, radiation therapy, chemotherapy, targeted therapy",
    prognosis: "Varies depending on grade and location. Early detection improves outcomes."
  },
  meningioma: {
    name: "Meningioma",
    description: "A tumor that arises from the meninges (protective membranes covering the brain).",
    symptoms: "Headaches, vision problems, hearing loss, seizures, weakness",
    treatment: "Observation, surgery, radiation therapy",
    prognosis: "Generally benign and slow-growing. Good outcomes with treatment."
  },
  pituitary: {
    name: "Pituitary Adenoma",
    description: "A tumor in the pituitary gland affecting hormone production.",
    symptoms: "Vision problems, hormonal imbalances, headaches, fatigue",
    treatment: "Medication, surgery, radiation therapy",
    prognosis: "Usually benign. Treatment can effectively manage symptoms."
  },
  notumor: {
    name: "No Tumor Detected",
    description: "The scan shows no signs of tumor presence.",
    symptoms: "N/A",
    treatment: "No treatment required. Regular monitoring recommended.",
    prognosis: "Excellent. Continue routine health checkups."
  }
}

function getRecommendations(tumorType: string, severity: string, confidence: number): string[] {
  if (tumorType === 'notumor') {
    return ["Continue regular health monitoring. Schedule annual checkups."]
  }
  
  const recommendations: string[] = []
  
  if (confidence > 90) {
    recommendations.push("High confidence detection - consult with a neurologist immediately")
  } else if (confidence > 70) {
    recommendations.push("Moderate confidence - recommend additional imaging (CT/MRI scan)")
  } else {
    recommendations.push("Low confidence - further diagnostic tests required")
  }
  
  if (severity === "High") {
    recommendations.push("Urgent medical attention required")
    recommendations.push("Consult with neurosurgeon for treatment options")
  } else if (severity === "Moderate") {
    recommendations.push("Schedule consultation with oncologist within 1-2 weeks")
    recommendations.push("May require biopsy for detailed analysis")
  } else {
    recommendations.push("Monitor with follow-up scans in 3-6 months")
    recommendations.push("Maintain healthy lifestyle and regular checkups")
  }
  
  return recommendations
}

interface AnalysisResultsProps {
  result: AnalysisResult
}

export function AnalysisResults({ result }: AnalysisResultsProps) {
  const [isDownloading, setIsDownloading] = useState(false)
  const tumorInfo = TUMOR_INFO[result.tumorType]
  const recommendations = getRecommendations(result.tumorType, result.severity, result.confidence)
  const timestamp = new Date().toLocaleString()

  const handleDownloadReport = () => {
    setIsDownloading(true)
    
    const reportText = `
BRAIN TUMOR ANALYSIS REPORT
Generated: ${timestamp}
${"=".repeat(60)}

PRIMARY DIAGNOSIS
Tumor Type: ${tumorInfo.name}
Confidence: ${result.confidence.toFixed(2)}%
Affected Area: ${result.affectedArea.toFixed(2)}%
Severity: ${result.severity}

TUMOR INFORMATION
Description: ${tumorInfo.description}
Symptoms: ${tumorInfo.symptoms}
Treatment: ${tumorInfo.treatment}
Prognosis: ${tumorInfo.prognosis}

CLASSIFICATION PROBABILITIES
${Object.entries(result.probabilities).map(([name, prob]) => `${name.charAt(0).toUpperCase() + name.slice(1)}: ${prob.toFixed(2)}%`).join('\n')}

RECOMMENDATIONS
${recommendations.map((rec, i) => `${i + 1}. ${rec}`).join('\n')}

DISCLAIMER
This analysis is generated by an AI system and should not replace 
professional medical diagnosis. Please consult with qualified 
healthcare providers for proper medical evaluation.
${"=".repeat(60)}
    `
    
    const blob = new Blob([reportText], { type: 'text/plain' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `brain_tumor_report_${new Date().toISOString().slice(0, 10)}.txt`
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)
    
    setIsDownloading(false)
  }

  const getSeverityConfig = (severity: string) => {
    switch (severity) {
      case "High":
        return { color: "bg-red-500/10 border-red-500/30 text-red-500", icon: XCircle }
      case "Moderate":
        return { color: "bg-amber-500/10 border-amber-500/30 text-amber-500", icon: AlertTriangle }
      case "Low":
        return { color: "bg-yellow-500/10 border-yellow-500/30 text-yellow-500", icon: AlertCircle }
      default:
        return { color: "bg-emerald-500/10 border-emerald-500/30 text-emerald-500", icon: CheckCircle }
    }
  }

  const severityConfig = getSeverityConfig(result.severity)
  const SeverityIcon = severityConfig.icon

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h3 className="text-2xl font-bold text-foreground">Analysis Results</h3>
          <p className="text-sm text-muted-foreground">Report generated: {timestamp}</p>
        </div>
        <div className="flex items-center gap-2 text-sm">
          <div className="h-2 w-2 rounded-full bg-emerald-500" />
          <span className="text-emerald-500 font-medium">Analysis Complete</span>
        </div>
      </div>

      {/* Primary Diagnosis */}
      <Card className={cn("border-2", severityConfig.color.split(" ").slice(0, 2).join(" "))}>
        <CardContent className="p-6">
          <div className="flex items-start gap-4">
            <div className={cn("rounded-full p-2", severityConfig.color.split(" ")[0])}>
              <SeverityIcon className={cn("h-6 w-6", severityConfig.color.split(" ")[2])} />
            </div>
            <div className="flex-1">
              <h4 className="text-xl font-semibold text-foreground">
                {result.tumorType === 'notumor' ? 'No Tumor Detected' : `${tumorInfo.name} Detected`}
              </h4>
              <p className="text-muted-foreground mt-1">{tumorInfo.description}</p>
              <div className="flex flex-wrap gap-4 mt-4">
                <div className="text-sm">
                  <span className="text-muted-foreground">Confidence: </span>
                  <span className="font-semibold text-foreground">{result.confidence.toFixed(1)}%</span>
                </div>
                {result.tumorType !== 'notumor' && (
                  <>
                    <div className="text-sm">
                      <span className="text-muted-foreground">Severity: </span>
                      <span className={cn("font-semibold", severityConfig.color.split(" ")[2])}>{result.severity}</span>
                    </div>
                    <div className="text-sm">
                      <span className="text-muted-foreground">Affected Area: </span>
                      <span className="font-semibold text-foreground">{result.affectedArea.toFixed(2)}%</span>
                    </div>
                  </>
                )}
              </div>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Metrics and Image Grid */}
      <div className="grid gap-6 lg:grid-cols-2">
        {/* Metrics */}
        <Card>
          <CardHeader>
            <CardTitle>Classification Probabilities</CardTitle>
            <CardDescription>
              Confidence scores for each tumor type
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            {Object.entries(result.probabilities).map(([name, probability]) => (
              <div key={name} className="space-y-2">
                <div className="flex items-center justify-between text-sm">
                  <span className="capitalize text-foreground font-medium">{name === 'notumor' ? 'No Tumor' : name}</span>
                  <span className="text-muted-foreground">{probability.toFixed(1)}%</span>
                </div>
                <Progress 
                  value={probability} 
                  className="h-2"
                />
              </div>
            ))}
          </CardContent>
        </Card>

        {/* Uploaded Image */}
        <Card>
          <CardHeader>
            <CardTitle>Uploaded MRI Scan</CardTitle>
            <CardDescription>
              Original image used for analysis
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="relative aspect-square overflow-hidden rounded-lg bg-muted">
              <Image
                src={result.originalImage}
                alt="Uploaded MRI scan"
                fill
                className="object-contain"
              />
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Tumor Information */}
      <Card>
        <CardHeader>
          <CardTitle>Tumor Information</CardTitle>
          <CardDescription>
            Educational information about the detected condition
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="grid gap-4 md:grid-cols-2">
            <InfoRow label="Description" value={tumorInfo.description} />
            <InfoRow label="Common Symptoms" value={tumorInfo.symptoms} />
            <InfoRow label="Treatment Options" value={tumorInfo.treatment} />
            <InfoRow label="Prognosis" value={tumorInfo.prognosis} />
          </div>
        </CardContent>
      </Card>

      {/* Recommendations */}
      <Card>
        <CardHeader>
          <CardTitle>Medical Recommendations</CardTitle>
          <CardDescription>
            Suggested next steps based on the analysis
          </CardDescription>
        </CardHeader>
        <CardContent>
          <ul className="space-y-3">
            {recommendations.map((rec, index) => (
              <li key={index} className="flex items-start gap-3">
                <span className="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-primary text-xs font-semibold text-primary-foreground">
                  {index + 1}
                </span>
                <span className="text-sm text-muted-foreground pt-0.5">{rec}</span>
              </li>
            ))}
          </ul>
        </CardContent>
      </Card>

      {/* Download Section */}
      <Card>
        <CardHeader>
          <CardTitle>Export Report</CardTitle>
          <CardDescription>
            Download the analysis report for your records
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="flex flex-wrap gap-4">
            <Button onClick={handleDownloadReport} disabled={isDownloading} className="gap-2">
              <FileText className="h-4 w-4" />
              Download Report (TXT)
            </Button>
            <Button variant="outline" className="gap-2" disabled>
              <Download className="h-4 w-4" />
              Download Heatmap (Coming Soon)
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* Disclaimer */}
      <div className="rounded-lg border border-destructive/30 bg-destructive/10 p-4">
        <div className="flex gap-3">
          <AlertTriangle className="h-5 w-5 text-destructive shrink-0 mt-0.5" />
          <div>
            <h4 className="font-semibold text-destructive">Medical Disclaimer</h4>
            <p className="text-sm text-destructive/80 mt-1">
              This AI system is designed for educational and research purposes only. It should NOT be used as a 
              substitute for professional medical advice, diagnosis, or treatment. Always seek the advice of 
              qualified healthcare providers with any questions regarding medical conditions.
            </p>
          </div>
        </div>
      </div>
    </div>
  )
}

function InfoRow({ label, value }: { label: string; value: string }) {
  return (
    <div className="space-y-1">
      <p className="text-sm font-medium text-foreground">{label}</p>
      <p className="text-sm text-muted-foreground">{value}</p>
    </div>
  )
}
